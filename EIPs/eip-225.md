# EIP-225: Clique proof-of-authority consensus protocol


## Abstract
이 문서는 이더리움 테스트넷의 원할한 작동을 위해 제안된 권한증명(proof-of-authority) 합의 알고리즘인 Clique을 제안한 EIP-225를 서술하고 분석합니다. Clique는 신뢰받는 노드들만이 합의에 참여할 수 있도록 하는 합의 알고리즘이며, 이더리움의 구조를 해치지 않고 모든 클라이언트에 최소 비용으로 추가될 수 있습니다. 이 문서에서는 Clique의 등장 배경과 그 구조, 실제 코드의 구현까지 살펴봅니다.

## Motivation
이더리움 첫번째 공식 테스트넷은 작업 증명 테스트넷인 Morden이었습니다.
Morden 테스트셋은 2015년 7월부터 2016년 11월까지 진행되었으나, go-ethereum 과 parity 두 노드 클라이언트 간의 테스트넷 전용 합의 문제와 누적된 정크 데이터로 인해 중단되었습니다. 

이후 다음 작업증명 테스트넷인 Ropsten으로 새롭게 시작되었습니다.Ropsten은 2017년 2월 말까지 잘 진행되었는데, 악의적인 공격자들이 테스트넷이 낮은 난이도를 가진다는 점을 악용하여 블록 가스 한도를 470만 개에서 90억 개로 점차적으로 부풀린후, 거대한 스팸 트랜잭션을 전송했습니다. Ropsten팀은 2017년 3월 커뮤니티에서 기부한 GPU 해시 파워를 투입하여 네트워크를 되살리는 데 성공하였으나 이러한 문제를 해결하기 위해 테스트넷을 위한 합의 알고리즘의 필요성이 대두되었습니다. 

이러한 DDOS 공격의 근본 원인은 PoW 블록체인은 블록체인의 네트워크 해시파워 만큼의 보안성을 가지기 때문입니다. 새로운 테스트넷을 제네시스 블록에서 다시 시작해도 공격자가 전체 51% 이상의 해시파워를 소유한 경우 동일한 공격을 반복해서 할 수 있기 때문에 아무 것도 해결되지 않습니다. 테스트넷은 가치가 없는 네트워크이기 때문에 충분히 안전해질 만큼의 해시파워를 가지기는 어렵습니다. 

## Standardized proof-of-authority

PoA(proof-of-authority) 합의 알고리즘은 신뢰할 수 있는 서명자에 의해서만 블록이 발행될 수 있다는 아이디어를 기반으로 합니다. 또한 PoA의 주요 목표는 기존 이더리움 클라이언트에 구현하고 추가하는 것이 매우 간단함과 동시에 기존 동기화 방식에 호환되어야 한다는 것입니다. 

PoA는 인증된 서명자 목록을 가지고 있으며, 서명자들은 투표를 통해 서명자 목록에 서명자를 추가하고,제거할 수 있습니다.

## Repurposing header fields for signing and voting

최대한의 블록 헤더 데이터 구조 변경을 피하기 위해 블록 헤더의 32바이트 추가 데이터(extraData) 섹션을 활용합니다. 일반적으로는 채굴자들이 자신들의 클라이언트 버전을 추가하지만 다른 메세지를 추가해도 문제가 발생하지 않습니다. 채굴자 서명을 추가하기 위해 이 필드를 65바이트로 확장합니다. 필드 길이의 확장은 해싱 과정에서 길이가 고려되지 않으므로, 문제가 발생하지 않습니다. 이 필드를 통해 블록을 받는 노드들은 승인된 서명자 목록과 그들의 지갑주소를 확인할 수 있게 합니다. 

작업증명을 위해 존재하던 채굴자 필드와 논스 필드는 서명자 목록을 업데이트 하는 경우에 사용됩니다. 일반 블록에서는 두 필드 모두 '0'으로 설정됩니다. 그러나 목록을 변경하고 싶을 경우 채굴자 필드에 투표 대상 "서명자"를 추가하고, 논스 필드에 '0'과 '0xff...f' 로 찬/반 여부를 입력합니다. 이를 통해 모든 노드들은 투표를 집계하고, 동적인 서명자 목록을 유지합니다.

이러한 투표가 지속적으로 쌓이는 것을 막기 위해 ethash의 에폭 개념을 활용합니다. 에폭이 변경되면 대기중인 투표를 비우고, 이는 체크포인트로도 활용됩니다. 동기화 과정에서 모든 투표를 재생하지 않고 체크포인트 해시만을 기반으로 동기화가 가능해집니다. 또한 이는 제네시스 헤더가 체인을 초기 서명자 목록을 포함하여 완전하게 정의할 수 있습니다.(?) 

<p align="center">
  <img src="img/block_header.png" alt="이더리움 블록 헤더" width="75%">
</p>

<p align="center">이더리움 블록 헤더</p>

## 공격 가능성

#### 공격 시나리오1: 악의적인 서명자 
악의적인 사용자가 서명자 목록에 추가되거나 서명자의 키에 문제가 발생할 수 있습니다. 따라서 Clique는 N의 서명자 목록이 주어지면, 모든 서명자가 해당 시점의 전체 K 블록에서 하나의 블록만을 투표할 수 있게끔 합니다. 이는 피해를 제한하고, 악의적인 사용자를 투표로 축출할 수 있게 합니다. 

#### 공격 시나리오2: 서명자 검열
또다른 공격 방식은 서명자가 자신들을 제거하려고 시도하는 블록을 검열하는 경우입니다. 이를 방지하기 위해 서명자가 생성할수 있는 블록을 2/N 블록 당 하나로 제한합니다. 따라서 서명자는 검열하기 위해 51% 이상의 서명 계정을 통제해야 하며 이는 이미 게임에 진 경우입니다. 

#### 공격 시나리오3: 스팸 서명자
다른 방식은 계속 새로운 서명자를 추가하는 스팸 투표를 블록에 추가하는 것입니다. 노드는 모든 투표를 집계해야 함으로 이는 무한하게 증가될 수 있습니다. 때문에 앞서 설명한 에폭을 활용해 일정 시간이 지나면 투표가 종료되게끔 합니다. 

#### 공격 시나리오4: 동시 차단
최악의 경우 서명자 수가 N이고, 해당 시점의 경쟁하는 블록의 수가 K라면 N-K+1의 서명자들이 경쟁할 수 있습니다. 경쟁을 피하기 위해 서명자들이 블록에 약간의 더미 오프셋을 추가하는 시나리오가 있을 수 있습니다. 이는 드물지만 작은 포크를 발생시킬 수 있습니다. 따라서 이러한 경우가 적발되면 투표를 통해 축출합니다. 

## 블록 권한 부여
서명자의 블록 승인은 서명을 제외한 모든 블록 헤더의 내용을 포함하는 해시값을 서명하는 것을 의미합니다. 이는 서명을 포함하지 않으므로 최종 블록 해시와는 다릅니다. 이는 secp256k1곡선을 사용해 서명되며 서명은 extraData에 추가됩니다. 앞서 서술한 공격 시나리오의 해결책으로 서명자는 연속된 블록 중 하나만 서명할 수 있습니다. 채굴자들은 서명 차례가 결정되며 순서는 고정되어 있지 않지만 맞는 차례에 서명한 경우 가중치를 얻습니다.

다음과 같은 제안된 전략은 네트워크 트래픽과 작은 분기를 줄일 수 있으므로 최적의 서명 전략은 다음과 같습니다.

1. 다음 블록의 최적 서명 시간(parent + BLOCK_PERIOD)을 계산합니다.
2. 서명자가 차례일 경우, 최적 시가까지 대기하고 즉시 방송합니다.
3. 서명자가 차례가 아닐 경우, 서명을 rand(SIGNER_COUNT * 500ms)만큼 지연시킵니다.

## 서명자에 대한 투표
에폭이 변경되는 경우 확정되지 않은 모든 투표는 삭제되고 처음부터 시작됩니다. 에폭 변경 블록의 헤더에는 투표가 포함되서는 안됩니다. 다수결에 도달한 투표은 즉시 효력을 발생합니다. 유효하지 않은 투표는 구현의 단순화를 위해 처벌받지 않습니다.

####  계단식 투표
서명자를 추방할 때 복잡한 경우가 발생할 수 잇습니다. 이전에 승인된 서명자가 제거되면 제안 승인에 필요한 서명자가 줄어들어 보류중인 제안이 다수결에 도달해 새 제안이 통과되는 상황이 발생합니다.

충돌하는 여러 제안이 동시에 통과되는경우 서명자가 자신이 생성한 모든 블록에서 자신의 투표를 뒤집을 수 있기 때문에, 어떤 제안을 우선해야 하는지는 명확하지 않습니다. 따라서 Clique는 이러한 문제를 해결하기 위해 블록의 투표 대상자(수혜자)만이 목록에서 제거되거나 삭제될 수 있도록 합니다. 과반에 도달한 다른 서명자가 있더라도 반영하지 않습니다.

####  투표 전략
블록체인에는 변경사항이 발생할 수 있으므로 투표한 블록이 최종 체인에 포함되지 않는 경우가 생길 수 있습니다. 


블록체인은 작은 재구성이 발생할 수 있으므로, “투표하고 잊기”라는 단순한 투표 메커니즘은 최적이 아닐 수 있습니다. 왜냐하면 단일 투표가 포함된 블록이 최종 체인에 포함되지 않을 수 있기 때문입니다. 따라서 투표를 하였더라도 해당 투표 내용을 즉시 제거하지 않고, "제안"으로 남겨 목록을 유지하도록 하여 재구성이 발생하더라도 다시 투표할 수 있도록 합니다. 

## Reference
https://eips.ethereum.org/EIPS/eip-225
https://preethikasireddy.medium.com/how-does-ethereum-work-anyway-22d1df506369

